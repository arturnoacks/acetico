<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
</head>
<body>

    <script>

    var velXBola;
    var velXBarra = 300;
    var objetos;
    var bola;
    var p1;
    var p2;
    var cursors;
    var keys;
    var bounce = 1;

    class GOTY extends Phaser.Scene
    {
        preload ()
        {
            this.load.image('bola','aceticos/bolaInsana.png');
            this.load.image('ret','aceticos/retanguloInsano.png');
        }

        create ()
        {
            objetos = this.physics.add.staticGroup();

            objetos.create(200, 300, 'ret').setScale(1.2).refreshBody();
            objetos.create(600, 300, 'ret').setScale(1.2).refreshBody();

            bola = this.physics.add.image(400, 300, 'bola');
            bola.setBounce(bounce, bounce);
            bola.setCollideWorldBounds(true);

            //p1 cima p2 baixo
            var firstPlayer = Phaser.Math.Between(1,2);
            var firtstYBallSpeed = firstPlayer==1 ? -200 : 200;

            velXBola = Phaser.Math.Between(-130,130);
            
            bola.body.showVelocity = true;
            bola.setVelocityY(firtstYBallSpeed);
            bola.setVelocityX(velXBola);

            p1 = this.physics.add.image(400, 25, 'ret');
            p2 = this.physics.add.image(400, 575, 'ret');
            p1.setCollideWorldBounds(true);
            p2.setCollideWorldBounds(true);

            p2.setImmovable(true);  p1.setImmovable(true);
            p2.onCollide = true;    p1.onCollide = true;
            
            this.physics.add.collider(bola, p1, rebateBola, null, this);
            this.physics.add.collider(bola, p2, rebateBola, null, this);
            this.physics.add.collider(bola, objetos);
            
            // this.physics.world.on('collide', function (bola, p1) {
            //     var vel = velXBarra + velXBola + Phaser.Math.Between(-50, 50);
            //     console.log(vel);
            //     bolaObj.setVelocityX(vel);
            // });

            //this.physics.world.on('collide', rebateBola(bola, p2, null, null));

            cursors = this.input.keyboard.createCursorKeys();
            keys = this.input.keyboard.addKeys('W,A,S,D');

        }

        update ()
        {
            if (cursors.right.isDown)
            {
                p1.setVelocityX(velXBarra);
            }
            else if (cursors.left.isDown)
            {
                p1.setVelocityX(-velXBarra);
            }
            else
            {
                p1.setVelocityX(0);
            }
            if(keys.A.isDown){
                p2.setVelocityX(-velXBarra);
            }
            else if(keys.D.isDown){
                p2.setVelocityX(velXBarra);
            }
            else{
                p2.setVelocityX(0);
            }
            if(bounce < 1.1) bounce += 0.0000001;
            bola.setBounce(bounce, bounce);

        }
    }
        function rebateBola (){
            var vel = velXBola + Phaser.Math.Between(-50, 50);
            console.log(vel);
            bola.setVelocityX(vel);
        }


    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        scene: GOTY,
        physics: {
            default: 'arcade',
            arcade: {
                debug : true
            }
        }
    };

    const game = new Phaser.Game(config);
    </script>

</body>
</html>